{"id":"i-30fj","uuid":"78bbe520-66da-4444-821b-f885df9245bc","title":"Complete Protobuf Definitions for All Services","content":"## Overview\nCreate complete, compilable `.proto` files for all services with full message definitions, enums, and service contracts. These definitions are **critical** for implementation and must be completed before any service implementation begins.\n\n## Scope\n\nAll protobuf messages referenced in the service specs must be defined in compilable `.proto` files.\n\n### Files to Create\n\n1. **`protos/payments/v1/common.proto`** - Common types, enums, metadata\n2. **`protos/payments/v1/payment_token.proto`** - Payment Token Service messages\n3. **`protos/payments/v1/authorization.proto`** - Authorization API messages\n4. **`protos/payments/v1/events.proto`** - All event message definitions\n\n### Required Messages\n\n#### Common Types (`common.proto`)\n- `Money`\n- `Timestamp`\n- `Address`\n- `EventMetadata`\n- `ErrorDetails`\n- `AuthStatus` enum\n- `VoidStatus` enum\n\n#### Payment Token Service (`payment_token.proto`)\n- `CreatePaymentTokenRequest`\n- `CreatePaymentTokenResponse`\n- `GetPaymentTokenRequest`\n- `GetPaymentTokenResponse`\n- `DecryptPaymentTokenRequest`\n- `DecryptPaymentTokenResponse`\n- `PaymentData`\n\n#### Authorization API (`authorization.proto`)\n- `AuthorizeRequest`\n- `AuthorizeResponse`\n- `GetAuthStatusRequest`\n- `GetAuthStatusResponse`\n- `VoidAuthRequest`\n- `VoidAuthResponse`\n- `AuthorizationResult`\n\n#### Events (`events.proto`)\n- `AuthRequestCreated`\n- `AuthRequestQueued` (or just JSON in outbox - TBD)\n- `AuthAttemptStarted`\n- `AuthResponseReceived`\n- `AuthAttemptFailed`\n- `AuthVoidRequested`\n- `AuthRequestExpired`\n\n## Acceptance Criteria\n\n- [ ] All `.proto` files compile with `protoc`\n- [ ] Python code generation works: `python -m grpc_tools.protoc`\n- [ ] All messages have field numbers assigned\n- [ ] All enums have values starting at 0 (with _UNSPECIFIED)\n- [ ] Comments/documentation for each message and field\n- [ ] Import statements correct (e.g., `import \"payments/v1/common.proto\"`)\n- [ ] Package names consistent: `payments.v1`\n\n## Implementation Steps\n\n1. Create `protos/` directory structure\n2. Define `common.proto` first (shared types)\n3. Define service-specific protos (importing common)\n4. Define `events.proto` (importing common + service types)\n5. Test compilation: `protoc --python_out=. --grpc_python_out=. protos/payments/v1/*.proto`\n6. Generate Python stubs and verify no errors\n\n## Dependencies\n\n**Blocks:**\n- [[s-7ujm]] Payment Token Service implementation\n- [[s-9jeq]] Authorization API Service implementation\n- [[s-w5sf]] Auth Processor Worker Service implementation\n\n## Priority\n\n**CRITICAL / P0** - No implementation can proceed without these definitions.\n\n## Notes\n\n- Follow [Google's Protobuf Style Guide](https://protobuf.dev/programming-guides/style/)\n- Use `snake_case` for field names\n- Use `CamelCase` for message names\n- Include version in package name (`payments.v1`)\n- Consider forward/backward compatibility (don't reuse field numbers)","status":"closed","priority":0,"assignee":null,"archived":0,"archived_at":null,"created_at":"2025-11-10 06:47:27","updated_at":"2025-11-10 07:59:19","closed_at":"2025-11-10 07:59:19","parent_id":null,"parent_uuid":null,"relationships":[{"from":"i-30fj","from_type":"issue","to":"s-w5sf","to_type":"spec","type":"blocks"},{"from":"i-30fj","from_type":"issue","to":"s-9jeq","to_type":"spec","type":"blocks"},{"from":"i-30fj","from_type":"issue","to":"s-7ujm","to_type":"spec","type":"blocks"}],"tags":["blocking","critical","protobuf"],"feedback":[{"id":"FB-005","issue_id":"i-30fj","spec_id":"s-94si","feedback_type":"comment","content":"**Protobuf Type Safety**: With protobuf definitions complete, all event serialization/deserialization now has type safety and schema validation. Events stored as BYTEA can be deserialized with: `AuthRequestCreated.FromString(event_data_bytes)`. Field additions are backward compatible as long as field numbers don't change.","agent":"randy","anchor":{"section_heading":"Core Principles","section_level":2,"line_number":10,"line_offset":6,"text_snippet":"","context_before":"- no eventual consistency delay for status queries","context_after":"## Transaction Boundaries  ### Authorization API: P","content_hash":"e3b0c44298fc1c14","anchor_status":"valid","last_verified_at":"2025-11-10T08:01:18.482Z","original_location":{"line_number":10,"section_heading":"Core Principles"}},"dismissed":false,"created_at":"2025-11-10 08:01:18","updated_at":"2025-11-10 08:01:18"},{"id":"FB-004","issue_id":"i-30fj","spec_id":"s-7ujm","feedback_type":"comment","content":"**Protobuf Serialization**: The `event_data BYTEA` column should store protobuf-serialized messages. Use `.SerializeToString()` for writing and `.FromString()` for reading. Example: `CreatePaymentTokenRequest(...).SerializeToString()`","agent":"randy","anchor":{"section_heading":"Encryption Flow","section_level":3,"line_number":42,"line_offset":25,"text_snippet":"1. Retrieves service_encrypted from database","context_before":"ecrypt with payment_token    Payment Token Service:","context_after":"2. Decrypts with current rotating_key: payment_d","content_hash":"42c2a38f05107e91","anchor_status":"valid","last_verified_at":"2025-11-10T08:01:11.237Z","original_location":{"line_number":42,"section_heading":"Encryption Flow"}},"dismissed":false,"created_at":"2025-11-10 08:01:11","updated_at":"2025-11-10 08:01:11"},{"id":"FB-003","issue_id":"i-30fj","spec_id":"s-9jeq","feedback_type":"comment","content":"**Import Note**: Services will need to import from `shared.python.payments_proto.payments.v1` package. Example: `from payments.v1.authorization_pb2 import AuthorizeRequest, AuthorizeResponse, AuthStatus`","agent":"randy","anchor":{"section_heading":"Overview","section_level":2,"line_number":3,"line_offset":2,"text_snippet":"","context_before":"s the main entry point for restaurant POS systems.","context_after":"## Service Boundaries - **Owns**: Auth request life","content_hash":"e3b0c44298fc1c14","anchor_status":"valid","last_verified_at":"2025-11-10T08:01:04.004Z","original_location":{"line_number":3,"section_heading":"Overview"}},"dismissed":false,"created_at":"2025-11-10 08:01:04","updated_at":"2025-11-10 08:01:04"},{"id":"FB-002","issue_id":"i-30fj","spec_id":"s-9jeq","feedback_type":"suggestion","content":"**Queue Message Format Change**: The pseudocode shows JSON serialization (`json.dumps({...})`), but the protos define `AuthRequestQueuedMessage` as protobuf. Update the outbox writes to use protobuf serialization: `AuthRequestQueuedMessage(...).SerializeToString()`","agent":"randy","anchor":{"section_heading":"POST /authorize","section_level":3,"line_number":67,"line_offset":17,"text_snippet":"","context_before":"h_request_id = 1;  // UUID   AuthStatus status = 2;","context_after":"// Populated if status = AUTHORIZED or DENIED   A","content_hash":"e3b0c44298fc1c14","anchor_status":"valid","last_verified_at":"2025-11-10T08:00:48.827Z","original_location":{"line_number":67,"section_heading":"POST /authorize"}},"dismissed":false,"created_at":"2025-11-10 08:00:48","updated_at":"2025-11-10 08:00:48"},{"id":"FB-001","issue_id":"i-30fj","spec_id":"s-8c0t","feedback_type":"suggestion","content":"**Schema Update Needed**: Since we're using protobuf for queue messages (AuthRequestQueuedMessage, VoidRequestQueuedMessage), the outbox.payload column should be `BYTEA` not `JSONB`. Update line ~130 in the schema section.","agent":"randy","anchor":{"section_heading":"Database Separation","section_level":3,"line_number":30,"line_offset":17,"text_snippet":"CREATE DATABASE payment_events_db;","context_before":"ASE payment_tokens_db;  -- payment_events_db (main)","context_after":"```  ## Queue Architecture (AWS SQS)  ### Auth Requ","content_hash":"6193c1db4b28e26c","anchor_status":"valid","last_verified_at":"2025-11-10T08:00:41.658Z","original_location":{"line_number":30,"section_heading":"Database Separation"}},"dismissed":false,"created_at":"2025-11-10 08:00:41","updated_at":"2025-11-10 08:00:41"}]}
{"id":"i-1l7d","uuid":"dbf5f9b2-1006-4cbf-8e4a-4cb3ff9a9eb6","title":"Setup Repository Directory Structure for Microservices Monorepo","content":"## Overview\nEstablish the directory structure for the payments infrastructure monorepo. This repo will contain multiple Python microservices with shared protobuf definitions and common utilities.\n\n## Services to Include\n1. **Payment Token Service** - PCI-compliant tokenization\n2. **Authorization API** - Main API entry point with outbox processor\n3. **Auth Processor Worker** - Background worker for payment processing\n4. *(Future)* Void Processor Worker, Capture Service, etc.\n\n## Proposed Directory Structure\n\n### Option A: Services-First (RECOMMENDED)\n\n```\npayments-infra/\n├── services/\n│   ├── payment-token/\n│   │   ├── src/\n│   │   │   └── payment_token/\n│   │   │       ├── __init__.py\n│   │   │       ├── api/\n│   │   │       │   ├── __init__.py\n│   │   │       │   ├── main.py          # FastAPI app\n│   │   │       │   └── routes.py\n│   │   │       ├── domain/\n│   │   │       │   ├── __init__.py\n│   │   │       │   ├── token.py         # Domain logic\n│   │   │       │   └── encryption.py\n│   │   │       ├── infrastructure/\n│   │   │       │   ├── __init__.py\n│   │   │       │   ├── database.py\n│   │   │       │   └── kms.py\n│   │   │       └── config.py\n│   │   ├── tests/\n│   │   │   ├── unit/\n│   │   │   ├── integration/\n│   │   │   └── conftest.py\n│   │   ├── Dockerfile\n│   │   ├── requirements.txt\n│   │   └── pyproject.toml\n│   │\n│   ├── authorization-api/\n│   │   ├── src/\n│   │   │   └── authorization_api/\n│   │   │       ├── __init__.py\n│   │   │       ├── api/\n│   │   │       │   ├── main.py\n│   │   │       │   └── routes/\n│   │   │       │       ├── authorize.py\n│   │   │       │       ├── status.py\n│   │   │       │       └── void.py\n│   │   │       ├── domain/\n│   │   │       │   ├── events.py\n│   │   │       │   └── read_models.py\n│   │   │       ├── infrastructure/\n│   │   │       │   ├── database.py\n│   │   │       │   ├── event_store.py\n│   │   │       │   └── outbox_processor.py\n│   │   │       └── config.py\n│   │   ├── tests/\n│   │   ├── Dockerfile\n│   │   ├── requirements.txt\n│   │   └── pyproject.toml\n│   │\n│   └── auth-processor-worker/\n│       ├── src/\n│       │   └── auth_processor/\n│       │       ├── __init__.py\n│       │       ├── worker.py            # Main worker loop\n│       │       ├── processors/\n│       │       │   ├── __init__.py\n│       │       │   ├── stripe.py\n│       │       │   └── chase.py (future)\n│       │       ├── clients/\n│       │       │   └── payment_token_client.py\n│       │       └── config.py\n│       ├── tests/\n│       ├── Dockerfile\n│       ├── requirements.txt\n│       └── pyproject.toml\n│\n├── shared/\n│   ├── protos/\n│   │   └── payments/\n│   │       └── v1/\n│   │           ├── common.proto\n│   │           ├── payment_token.proto\n│   │           ├── authorization.proto\n│   │           └── events.proto\n│   │\n│   └── python/\n│       ├── payments_common/              # Shared Python utilities\n│       │   ├── __init__.py\n│       │   ├── database/\n│       │   │   ├── __init__.py\n│       │   │   ├── base.py             # SQLAlchemy base\n│       │   │   └── connection.py\n│       │   ├── logging/\n│       │   │   └── structured_logger.py\n│       │   ├── auth/\n│       │   │   └── jwt_validator.py\n│       │   └── testing/\n│       │       └── fixtures.py\n│       ├── payments_proto/               # Generated protobuf code\n│       │   └── payments/\n│       │       └── v1/\n│       │           ├── common_pb2.py\n│       │           ├── payment_token_pb2.py\n│       │           └── ...\n│       ├── requirements.txt\n│       └── pyproject.toml\n│\n├── infrastructure/\n│   ├── terraform/\n│   │   ├── modules/\n│   │   │   ├── rds/\n│   │   │   ├── sqs/\n│   │   │   └── ecs/\n│   │   ├── environments/\n│   │   │   ├── dev/\n│   │   │   ├── staging/\n│   │   │   └── production/\n│   │   └── main.tf\n│   │\n│   ├── docker/\n│   │   └── docker-compose.yml           # Local development\n│   │\n│   └── kubernetes/ (optional, if using K8s instead of ECS)\n│       └── ...\n│\n├── tests/\n│   ├── integration/                      # Cross-service integration tests\n│   │   └── test_auth_flow.py\n│   └── e2e/                              # End-to-end tests\n│       └── test_payment_flow.py\n│\n├── scripts/\n│   ├── generate_protos.sh                # Compile protobufs\n│   ├── setup_local_db.sh                 # Initialize local postgres\n│   └── seed_test_data.py                 # Seed test restaurant configs\n│\n├── docs/\n│   └── specs/                            # Copy of .sudocode/specs\n│\n├── .github/\n│   └── workflows/\n│       ├── ci.yml\n│       └── deploy.yml\n│\n├── .sudocode/\n│   ├── specs.jsonl\n│   └── issues.jsonl\n│\n├── .gitignore\n├── README.md\n├── pyproject.toml                        # Root project config (Poetry/Rye)\n└── Makefile                              # Common tasks\n```\n\n### Key Design Decisions\n\n#### 1. Service Isolation\n- Each service has its own `requirements.txt`, `Dockerfile`, and test suite\n- Services can be deployed independently\n- Clear boundaries between services\n\n#### 2. Shared Code Organization\n- **`shared/protos/`**: Single source of truth for protobuf definitions\n- **`shared/python/payments_common/`**: Shared utilities (database, logging, auth)\n- **`shared/python/payments_proto/`**: Generated protobuf Python code\n\n#### 3. Protobuf Code Generation\nGenerated code goes in `shared/python/payments_proto/` and is importable by all services:\n\n```python\n# In any service\nfrom payments_proto.payments.v1 import authorization_pb2\nfrom payments_common.database import get_connection\n```\n\n#### 4. Python Package Structure\nEach service is a proper Python package:\n```python\n# services/authorization-api/src/authorization_api/\nfrom authorization_api.api.main import app\nfrom authorization_api.domain.events import AuthRequestCreated\n```\n\n#### 5. Testing Strategy\n- **Unit tests**: Alongside each service (`services/*/tests/unit/`)\n- **Integration tests**: Cross-service tests in `tests/integration/`\n- **E2E tests**: Full flow tests in `tests/e2e/`\n\n## Acceptance Criteria\n\n- [ ] Directory structure created\n- [ ] Each service has `pyproject.toml` or `requirements.txt`\n- [ ] `shared/protos/` directory with placeholder `.proto` files\n- [ ] `shared/python/payments_common/` with `__init__.py`\n- [ ] Root `Makefile` with common tasks:\n  - `make proto` - Generate protobuf code\n  - `make test` - Run all tests\n  - `make docker-up` - Start local environment\n  - `make lint` - Run linters\n- [ ] `docker-compose.yml` for local development (postgres, localstack, all services)\n- [ ] `.gitignore` configured for Python, proto generated code, etc.\n- [ ] Root `README.md` with:\n  - Architecture overview\n  - Quick start guide\n  - Links to service READMEs\n\n## Implementation Steps\n\n1. **Create directory structure** from root\n2. **Add placeholder files**:\n   - Empty `__init__.py` in all Python packages\n   - Placeholder `requirements.txt` with common deps\n   - Template `Dockerfile` for each service\n3. **Create `scripts/generate_protos.sh`**:\n   ```bash\n   #!/bin/bash\n   protoc --python_out=shared/python/payments_proto \\\n          --grpc_python_out=shared/python/payments_proto \\\n          -I shared/protos \\\n          shared/protos/payments/v1/*.proto\n   ```\n4. **Create root `Makefile`** with common tasks\n5. **Create `docker-compose.yml`** for local development\n6. **Add `.gitignore`** with Python, protobufs, IDE files\n7. **Document in root `README.md`**\n\n## Questions to Resolve\n\n1. **Python package manager**: Poetry, Rye, or just pip + requirements.txt?\n2. **Monorepo tool**: Use Pants, Bazel, or just Make + shell scripts?\n3. **Proto generation**: Commit generated code or generate at build time?\n4. **Service communication**: REST with protobuf over HTTP, or gRPC?\n   - Current spec says REST APIs, but protobufs for serialization\n   - Internal APIs could use gRPC (e.g., Payment Token Service internal decrypt)\n\n## Dependencies\n\n**Blocks:**\n- [[i-30fj]] Complete Protobuf Definitions (need directory structure first)\n- [[s-7ujm]] Payment Token Service implementation\n- [[s-9jeq]] Authorization API Service implementation\n- [[s-w5sf]] Auth Processor Worker Service implementation\n\n## Priority\n\n**CRITICAL / P0** - Must be done before any code is written\n\n## Additional Considerations\n\n### Alternative: Flat Structure (NOT RECOMMENDED)\n```\n/\n├── payment_token_service/\n├── authorization_api/\n├── auth_processor_worker/\n├── shared/\n└── ...\n```\n**Why not?** Less organized as repo grows, harder to distinguish services from infrastructure.\n\n### Proto Generated Code: Commit or Gitignore?\n\n**Option A: Commit generated code**\n- ✅ Easier for contributors (no setup needed)\n- ❌ Large diffs on proto changes\n- ❌ Merge conflicts\n\n**Option B: Gitignore generated code**\n- ✅ Smaller repo, cleaner diffs\n- ✅ Forces regeneration (always in sync)\n- ❌ Requires setup step for contributors\n\n**Recommendation**: Gitignore and generate during `make setup` or in CI.\n\n## Notes\n\n- Follow [Google's Python Style Guide](https://google.github.io/styleguide/pyguide.html)\n- Use `black` for formatting, `ruff` for linting\n- Each service README should document:\n  - What it does\n  - How to run locally\n  - How to run tests\n  - Environment variables","status":"closed","priority":0,"assignee":null,"archived":0,"archived_at":null,"created_at":"2025-11-10 06:50:42","updated_at":"2025-11-10 07:13:31","closed_at":"2025-11-10 07:13:31","parent_id":null,"parent_uuid":null,"relationships":[{"from":"i-1l7d","from_type":"issue","to":"i-30fj","to_type":"issue","type":"blocks"},{"from":"i-1l7d","from_type":"issue","to":"s-7ujm","to_type":"spec","type":"blocks"},{"from":"i-1l7d","from_type":"issue","to":"s-9jeq","to_type":"spec","type":"blocks"},{"from":"i-1l7d","from_type":"issue","to":"s-w5sf","to_type":"spec","type":"blocks"}],"tags":["critical","infrastructure","setup"]}
